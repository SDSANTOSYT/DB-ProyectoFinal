-- ddl_full.sql
-- Script a ejecutar en Oracle (SQL Developer). Crea las 17 tablas del modelo.
SET SERVEROUTPUT ON;

-- DROP tablas si existen (intento seguro)
BEGIN
  FOR t IN (SELECT table_name FROM user_tables WHERE table_name IN (
    'NOTA','COMPONENTE','PERIODO','HORARIO','GRUPO','MATERIA',
    'ASISTENCIA_AULA_ESTUDIANTE','ASISTENCIA_AULA_TUTOR','REGISTRO_DE_CAMBIO',
    'FESTIVO','MOTIVO','ESTUDIANTE','TUTOR','USUARIO','PERSONA',
    'AULA','PROGRAMA','SEDE','INSTITUCION'
  )) LOOP
    BEGIN
      EXECUTE IMMEDIATE 'DROP TABLE ' || t.table_name || ' CASCADE CONSTRAINTS';
    EXCEPTION WHEN OTHERS THEN NULL;
    END;
  END LOOP;
END;
/
-- ===================================================================
-- 1. INSTITUCION
CREATE TABLE INSTITUCION (
  ID_INSTITUCION NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
  NOMBRE VARCHAR2(200) NOT NULL,
  DURACIONHORA NUMBER NOT NULL,
  JORNADA VARCHAR2(100) NOT NULL
);

-- 2. SEDE
CREATE TABLE SEDE (
  ID_SEDE        NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY,
  ID_INSTITUCION NUMBER NOT NULL,
  NOMBRE_SEDE    VARCHAR2(200) NOT NULL,
  DIRECCION      VARCHAR2(300),
  TELEFONO       VARCHAR2(20),
  CONSTRAINT PK_SEDE_COMPOSITE PRIMARY KEY (ID_SEDE, ID_INSTITUCION),
  CONSTRAINT FK_SEDE_INSTITUCION FOREIGN KEY (ID_INSTITUCION) REFERENCES INSTITUCION(ID_INSTITUCION)
);

-- 3. PROGRAMA
CREATE TABLE PROGRAMA (
  ID_PROGRAMA NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
  TIPO VARCHAR2(100) NOT NULL
);

-- 4. AULA 
CREATE TABLE AULA (
  ID_AULA NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY,
  NOMBRE_AULA VARCHAR2(200) NOT NULL,
  GRADO VARCHAR2(50),
  ID_SEDE NUMBER NOT NULL,
  ID_INSTITUCION NUMBER NOT NULL,
  ID_TUTOR NUMBER,
  ID_PROGRAMA NUMBER,
  CONSTRAINT PK_AULA PRIMARY KEY (ID_AULA, ID_SEDE, ID_INSTITUCION),
  CONSTRAINT FK_AULA_SEDE_COMPOSITE FOREIGN KEY (ID_SEDE, ID_INSTITUCION) REFERENCES SEDE (ID_SEDE, ID_INSTITUCION),
  CONSTRAINT FK_AULA_PROGRAMA FOREIGN KEY (ID_PROGRAMA) REFERENCES PROGRAMA(ID_PROGRAMA)
  -- FK_AULA_TUTOR se añadirá luego para evitar dependencia forward
);

-- 5. PERSONA
CREATE TABLE PERSONA (
  ID_PERSONA NUMBER PRIMARY KEY,
  NOMBRE VARCHAR2(200) NOT NULL,
  ROL VARCHAR2(50),
  CORREO VARCHAR2(100) NOT NULL UNIQUE
);

-- 6. USUARIO
CREATE TABLE USUARIO (
  ID_USUARIO NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
  CONTRASENA VARCHAR2(200) NOT NULL,
  ID_PERSONA NUMBER UNIQUE,
  CONSTRAINT FK_USUARIO_PERSONA FOREIGN KEY (ID_PERSONA) REFERENCES PERSONA(ID_PERSONA)
);

-- 7. TUTOR
CREATE TABLE TUTOR (
  ID_TUTOR NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
  ID_PERSONA NUMBER UNIQUE,
  CONSTRAINT FK_TUTOR_PERSONA FOREIGN KEY (ID_PERSONA) REFERENCES PERSONA(ID_PERSONA)
);

-- 8. ESTUDIANTE 
CREATE TABLE ESTUDIANTE (
  ID_ESTUDIANTE NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
  TIPO_DOCUMENTO VARCHAR2(50),
  NOMBRE VARCHAR2(200) NOT NULL,
  GRADO VARCHAR2(50),
  SCORE_INICIAL NUMBER,
  SCORE_FINAL NUMBER,
  ID_AULA NUMBER,
  ID_SEDE NUMBER,
  ID_INSTITUCION NUMBER,
  CONSTRAINT FK_ESTUDIANTE_AULA FOREIGN KEY (ID_AULA, ID_SEDE, ID_INSTITUCION) REFERENCES AULA(ID_AULA, ID_SEDE, ID_INSTITUCION)
);

-- 9. HORARIO 
CREATE TABLE HORARIO (
  ID_HORARIO NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
  DIA VARCHAR2(30),
  HORA_INICIO VARCHAR2(10),
  HORA_FIN VARCHAR2(10),
  ID_AULA NUMBER,
  ID_SEDE NUMBER,
  ID_INSTITUCION NUMBER,
  CONSTRAINT FK_HORARIO_AULA FOREIGN KEY (ID_AULA, ID_SEDE, ID_INSTITUCION) REFERENCES AULA(ID_AULA, ID_SEDE, ID_INSTITUCION)
);

-- 10. PERIODO
CREATE TABLE PERIODO (
  ID_PERIODO NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
  FECHA_INICIO DATE,
  FECHA_FIN DATE,
  ID_PROGRAMA NUMBER,
  CONSTRAINT FK_PERIODO_PROGRAMA FOREIGN KEY (ID_PROGRAMA) REFERENCES PROGRAMA(ID_PROGRAMA)
);

-- 11. COMPONENTE
CREATE TABLE COMPONENTE (
  ID_COMPONENTE NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
  NOMBRE VARCHAR2(200),
  PORCENTAJE NUMBER(5,2),
  ID_PROGRAMA NUMBER,
  CONSTRAINT FK_COMPONENTE_PROGRAMA FOREIGN KEY (ID_PROGRAMA) REFERENCES PROGRAMA(ID_PROGRAMA)
);

-- 12. NOTA
CREATE TABLE NOTA (
  ID_NOTA NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
  VALOR NUMBER(6,2),
  ID_ESTUDIANTE NUMBER,
  ID_PERIODO NUMBER,
  ID_COMPONENTE NUMBER,
  ID_TUTOR NUMBER,
  CONSTRAINT FK_NOTA_ESTUDIANTE FOREIGN KEY (ID_ESTUDIANTE) REFERENCES ESTUDIANTE(ID_ESTUDIANTE),
  CONSTRAINT FK_NOTA_PERIODO FOREIGN KEY (ID_PERIODO) REFERENCES PERIODO(ID_PERIODO),
  CONSTRAINT FK_NOTA_COMPONENTE FOREIGN KEY (ID_COMPONENTE) REFERENCES COMPONENTE(ID_COMPONENTE),
  CONSTRAINT FK_NOTA_TUTOR FOREIGN KEY (ID_TUTOR) REFERENCES TUTOR(ID_TUTOR)
);

-- 13. MOTIVO (MOVIDO ANTES DE ASISTENCIA_AULA_TUTOR)
CREATE TABLE MOTIVO (
  ID_MOTIVO NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
  DESCRIPCION VARCHAR2(400)
);

-- 14. ASISTENCIA_AULA_TUTOR
CREATE TABLE ASISTENCIA_AULA_TUTOR (
    ID_ASISTENCIA                 NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    ID_TUTOR                      NUMBER NOT NULL,
    ID_AULA                       NUMBER NOT NULL,
    ID_SEDE                       NUMBER NOT NULL,
    ID_INSTITUCION                NUMBER NOT NULL,
    FECHA                         DATE,
    HORA_ENTRADA                   VARCHAR2(10),
    HORA_SALIDA                    VARCHAR2(10),
    SE_DIO                        NUMBER(1) DEFAULT 1,
    ID_MOTIVO                     NUMBER,
    ID_ASISTENCIA_REPOSICION      NUMBER,
    ID_HORARIO                    NUMBER,
  CONSTRAINT FK_AATT_TUTOR FOREIGN KEY (ID_TUTOR) REFERENCES TUTOR(ID_TUTOR),
  CONSTRAINT FK_AAT_AULA_COMPO FOREIGN KEY (ID_AULA, ID_SEDE, ID_INSTITUCION) REFERENCES AULA (ID_AULA, ID_SEDE, ID_INSTITUCION) ON DELETE CASCADE,
  CONSTRAINT FK_AATT_HORARIO FOREIGN KEY (ID_HORARIO) REFERENCES HORARIO(ID_HORARIO),
  CONSTRAINT FK_AATT_MOTIVO FOREIGN KEY (ID_MOTIVO) REFERENCES MOTIVO(ID_MOTIVO),
  CONSTRAINT FK_AATT_REPOSICION FOREIGN KEY (ID_ASISTENCIA_REPOSICION) REFERENCES ASISTENCIA_AULA_TUTOR(ID_ASISTENCIA)
);

-- 15. ASISTENCIA_AULA_ESTUDIANTE
CREATE TABLE ASISTENCIA_AULA_ESTUDIANTE (
    ID_ASISTENCIA           NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    ID_ESTUDIANTE           NUMBER NOT NULL,
    ID_AULA                 NUMBER NOT NULL,
    ID_SEDE                 NUMBER NOT NULL,
    ID_INSTITUCION          NUMBER NOT NULL,
    FECHA                   DATE,
    HORA_ENTRADA             VARCHAR2(10),
    HORA_SALIDA              VARCHAR2(10),
    PRESENTE                NUMBER(1) DEFAULT 1,

    -- FK hacia ESTUDIANTE
    CONSTRAINT FK_AAE_ESTUDIANTE FOREIGN KEY (ID_ESTUDIANTE)
        REFERENCES ESTUDIANTE (ID_ESTUDIANTE),

    -- FK compuesta hacia AULA (ID_AULA, ID_SEDE, ID_INSTITUCION)
    CONSTRAINT FK_AAE_AULA_COMPO FOREIGN KEY (ID_AULA, ID_SEDE, ID_INSTITUCION)
        REFERENCES AULA (ID_AULA, ID_SEDE, ID_INSTITUCION)
        ON DELETE CASCADE
);

-- 16. FESTIVO
CREATE TABLE FESTIVO (
  ID_FESTIVO NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
  FECHA_FESTIVO DATE,
  DESCRIPCION VARCHAR2(400)
);

-- 17. REGISTRO_DE_CAMBIO
CREATE TABLE REGISTRO_DE_CAMBIO (
  ID_REGISTRO_DE_CAMBIO NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
  FECHA DATE,
  HORA VARCHAR2(20),
  MOTIVO VARCHAR2(400),
  ID_PERSONA NUMBER,
  ID_TUTOR NUMBER,
  CONSTRAINT FK_REGCAM_PERSONA FOREIGN KEY (ID_PERSONA) REFERENCES PERSONA(ID_PERSONA),
  CONSTRAINT FK_REGCAM_TUTOR FOREIGN KEY (ID_TUTOR) REFERENCES TUTOR(ID_TUTOR)
);

-- ahora añadimos FK AULA -> TUTOR (se creó TUTOR)
BEGIN
  BEGIN
    EXECUTE IMMEDIATE 'ALTER TABLE AULA ADD CONSTRAINT FK_AULA_TUTOR FOREIGN KEY (ID_TUTOR) REFERENCES TUTOR(ID_TUTOR)';
  EXCEPTION WHEN OTHERS THEN NULL;
  END;
END;
/

-- Índices sugeridos
CREATE INDEX IDX_PERSONA_NOMBRE ON PERSONA(NOMBRE);
CREATE INDEX IDX_ESTUDIANTE_NOMBRE ON ESTUDIANTE(NOMBRE);
CREATE INDEX IDX_ESTUDIANTE_AULA ON ESTUDIANTE(ID_AULA, ID_SEDE);
CREATE INDEX IDX_HORARIO_AULA ON HORARIO(ID_AULA, ID_SEDE);
CREATE INDEX IDX_ASIST_FECHA ON ASISTENCIA_AULA_TUTOR(FECHA);
CREATE INDEX IDX_NOTA_ESTUDIANTE ON NOTA(ID_ESTUDIANTE);

COMMIT;
